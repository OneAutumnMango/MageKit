name: Package BepInEx

on:
  push:
    branches:
      - main
    tags:
      - '?*.?*.?*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  package-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Fail if tag does not match Plugin version
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          set -e
          TAG_NAME="${GITHUB_REF##*/}"
          VERSION=$(grep -oP '\[BepInPlugin\([^,]+, *[^,]+, *"\K[^"]+' ./Plugin.cs)
          echo "Tag: $TAG_NAME"
          echo "Plugin version: $VERSION"
          if [ "$TAG_NAME" != "$VERSION" ]; then
            echo "::error::Tag ($TAG_NAME) does not match Plugin version ($VERSION)" >&2
            exit 1
          fi

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '9.0.x'

      - name: Build
        run: |
          dotnet build --configuration Release

      - name: Create BepInEx package
        run: |
          set -e

          DLL_PATH="bin/Release/net472/MageKit.dll"

          if [ ! -f "$DLL_PATH" ]; then
            echo "Error: $DLL_PATH not found" >&2
            echo "Built files:" >&2
            find bin -type f >&2
            exit 1
          fi

          mkdir -p BepInEx/plugins
          cp "$DLL_PATH" BepInEx/plugins/MageKit.dll

          zip -r BepInEx.zip BepInEx

      - name: Upload workflow artifact
        if: startsWith(github.ref, 'refs/tags/') == false
        uses: actions/upload-artifact@v4
        with:
          name: BepInEx
          path: BepInEx.zip

      - name: Upload MageKit.dll artifact
        if: startsWith(github.ref, 'refs/tags/') == false
        uses: actions/upload-artifact@v4
        with:
          name: MageKit.dll
          path: bin/Release/net472/MageKit.dll

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          artifacts: "BepInEx.zip,bin/Release/net472/MageKit.dll"
          bodyFile: README.md

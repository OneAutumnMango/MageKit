name: Package BepInEx

on:
  push:
    branches:
      - main
    tags:
      - '?*.?*.?*'
  workflow_dispatch:

jobs:
  package-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Create BepInEx package
        run: |
          set -e

          DLL_PATH="bin/Debug/net472/BalancePatch.dll"

          if [ ! -f "$DLL_PATH" ]; then
            echo "Error: $DLL_PATH not found" >&2
            exit 1
          fi

          mkdir -p BepInEx/plugins
          cp "$DLL_PATH" BepInEx/plugins/BalancePatch.dll

          zip -r BepInEx.zip BepInEx

      # Always upload as a workflow artifact
      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: BepInEx
          path: BepInEx.zip

      # Only create a release if this is a tag
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          artifacts: "BepInEx.zip"
          bodyFile: README.md
